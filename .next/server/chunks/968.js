"use strict";exports.id=968,exports.ids=[968],exports.modules={4133:(a,b,c)=>{c.d(b,{A:()=>h}),c(60687);var d=c(43210);c(16189);var e=c(67353);class f{static{this.TOKEN_KEY="authToken"}static{this.USER_KEY="currentUser"}static async login(a){try{let b=await e.uE.post("/auth/login",a);return this.setToken(b.token),this.setUser(b.user),b}catch(a){throw console.error("Login failed:",a),a}}static async register(a){try{let b=await e.uE.post("/auth/register",a);return this.setToken(b.token),this.setUser(b.user),b}catch(a){throw console.error("Registration failed:",a),a}}static async logout(){try{this.getToken()&&await e.uE.post("/auth/logout")}catch(a){console.error("Logout API call failed:",a)}finally{this.clearAuth()}}static async getCurrentUser(){try{let a=await e.uE.get("/auth/me"),b={id:a.user.id,username:a.user.username,email:a.user.email,role:a.user.role,avatar:a.user.avatar_url,totalPoints:0,createdAt:"",updatedAt:""};return this.setUser(b),b}catch(a){return console.error("Failed to get current user:",a),this.clearAuth(),null}}static isAuthenticated(){let a=this.getToken(),b=this.getStoredUser();return!!(a&&b)}static getToken(){return localStorage.getItem(this.TOKEN_KEY)}static getStoredUser(){try{let a=localStorage.getItem(this.USER_KEY);return a?JSON.parse(a):null}catch(a){return console.error("Failed to parse stored user:",a),null}}static setToken(a){localStorage.setItem(this.TOKEN_KEY,a)}static setUser(a){let b={id:a.id,username:a.username,email:a.email,role:a.role,avatar:a.avatarUrl||a.avatar_url,totalPoints:a.totalPoints||0,createdAt:a.createdAt||"",updatedAt:a.updatedAt||""};localStorage.setItem(this.USER_KEY,JSON.stringify(b))}static clearAuth(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY)}static isValidTokenFormat(a){return 3===a.split(".").length}static isTokenExpired(a){try{if(!this.isValidTokenFormat(a))return!0;let b=JSON.parse(atob(a.split(".")[1])),c=Math.floor(Date.now()/1e3);return b.exp&&b.exp<c}catch(a){return console.error("Failed to check token expiration:",a),!0}}static async refreshTokenIfNeeded(){let a=this.getToken();return!!a&&(!this.isTokenExpired(a)||(this.clearAuth(),!1))}static async initializeAuth(){let a=this.getToken();return a?this.isTokenExpired(a)?(this.clearAuth(),null):await this.getCurrentUser():null}}new f;let g=(0,d.createContext)(void 0);function h(){let a=(0,d.useContext)(g);if(void 0===a)throw Error("useAuth must be used within an AuthProvider");return a}},22078:(a,b,c)=>{c.d(b,{Layout:()=>d});let d=(0,c(61369).registerClientReference)(function(){throw Error("Attempted to call Layout() from the server but Layout is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/kop/coding/KD_Family/components/layout/Layout.tsx","Layout")},27720:(a,b,c)=>{c.d(b,{Layout:()=>n});var d=c(60687),e=c(43210),f=c(85814),g=c.n(f),h=c(16189),i=c(49384);let j=({children:a,className:b,variant:c="default",hover:e=!1,onClick:f})=>(0,d.jsx)("div",{className:(0,i.$)("glass-container",{default:"",card:"glass-card",modal:"p-6 max-w-md mx-auto",sidebar:"h-full"}[c],e?"hover:bg-white/15 hover:scale-[1.02] transition-all duration-300":"",f?"cursor-pointer":"",b),onClick:f,children:a});var k=c(4133),l=c(7956);let m={advisor:{canCreateTasks:!0,canAssignTasks:!0,canApproveTasks:!0,canManageUsers:!0,canViewAllStats:!0,canDeleteTasks:!0,canModifyPoints:!0},parent:{canCreateTasks:!0,canAssignTasks:!0,canApproveTasks:!0,canManageUsers:!1,canViewAllStats:!0,canDeleteTasks:!1,canModifyPoints:!1},member:{canCreateTasks:!1,canAssignTasks:!1,canApproveTasks:!1,canManageUsers:!1,canViewAllStats:!1,canDeleteTasks:!1,canModifyPoints:!1}},n=({children:a})=>{let{user:b,logout:c}=(0,k.A)(),{addNotification:f}=(0,l.h)(),i=(0,h.usePathname)(),[n,o]=(0,e.useState)(!1),p=async()=>{try{await c(),f({type:"success",message:"已成功退出登录"})}catch(a){f({type:"error",message:"退出登录失败"})}},q=a=>i===a||i.startsWith(a+"/"),r=b&&m[b.role]?.canManageUsers;return(0,d.jsx)("div",{className:"min-h-screen p-4",children:(0,d.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,d.jsx)("header",{className:"mb-8",children:(0,d.jsx)(j,{className:"p-6",children:(0,d.jsxs)("div",{className:"flex items-center justify-between",children:[(0,d.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,d.jsx)("img",{src:"/assets/logo.svg",alt:"KD之家",className:"w-10 h-10"}),(0,d.jsxs)("div",{children:[(0,d.jsx)("h1",{className:"text-2xl font-bold text-white",children:"KD之家"}),(0,d.jsx)("p",{className:"text-glass-muted",children:"现代化家务积分管理系统"})]})]}),(0,d.jsxs)("div",{className:"flex items-center space-x-6",children:[(0,d.jsxs)("nav",{className:"hidden md:flex space-x-4",children:[(0,d.jsx)(g(),{href:"/dashboard",className:`px-3 py-2 rounded-lg transition-colors ${q("/dashboard")?"bg-white/20 text-white":"text-glass hover:text-white hover:bg-white/10"}`,children:"仪表板"}),(0,d.jsx)(g(),{href:"/tasks",className:`px-3 py-2 rounded-lg transition-colors ${q("/tasks")?"bg-white/20 text-white":"text-glass hover:text-white hover:bg-white/10"}`,children:"任务"}),(0,d.jsx)(g(),{href:"/leaderboard",className:`px-3 py-2 rounded-lg transition-colors ${q("/leaderboard")?"bg-white/20 text-white":"text-glass hover:text-white hover:bg-white/10"}`,children:"排行榜"}),(0,d.jsx)(g(),{href:"/profile",className:`px-3 py-2 rounded-lg transition-colors ${q("/profile")?"bg-white/20 text-white":"text-glass hover:text-white hover:bg-white/10"}`,children:"个人资料"}),r&&(0,d.jsx)(g(),{href:"/admin",className:`px-3 py-2 rounded-lg transition-colors ${q("/admin")?"bg-white/20 text-white":"text-glass hover:text-white hover:bg-white/10"}`,children:"管理"})]}),(0,d.jsxs)("div",{className:"relative",children:[(0,d.jsxs)("button",{onClick:()=>o(!n),className:"flex items-center space-x-3 p-2 rounded-lg hover:bg-white/10 transition-colors",children:[(0,d.jsx)("div",{className:"w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center",children:(0,d.jsx)("span",{className:"text-white font-semibold text-sm",children:b?.username?.charAt(0).toUpperCase()})}),(0,d.jsxs)("div",{className:"hidden sm:block text-left",children:[(0,d.jsx)("p",{className:"text-white text-sm font-medium",children:b?.username}),(0,d.jsx)("p",{className:"text-glass-muted text-xs",children:b?.role})]})]}),n&&(0,d.jsxs)("div",{className:"absolute right-0 mt-2 w-48 glass-container p-2 z-50",children:[(0,d.jsx)(g(),{href:"/profile",className:"block px-3 py-2 text-glass hover:text-white hover:bg-white/10 rounded-lg transition-colors",onClick:()=>o(!1),children:"个人资料"}),(0,d.jsx)("button",{onClick:()=>{o(!1),p()},className:"w-full text-left px-3 py-2 text-glass hover:text-white hover:bg-white/10 rounded-lg transition-colors",children:"退出登录"})]})]})]})]})})}),(0,d.jsx)("main",{children:a})]})})}},56832:(a,b,c)=>{c.d(b,{k:()=>e});var d=c(37413);function e({size:a="md",className:b=""}){return(0,d.jsx)("div",{className:`flex items-center justify-center ${b}`,children:(0,d.jsx)("div",{className:`${{sm:"w-4 h-4",md:"w-8 h-8",lg:"w-12 h-12"}[a]} animate-spin rounded-full border-2 border-gray-300 border-t-blue-600`})})}},58895:(a,b,c)=>{c.d(b,{ProtectedRoute:()=>h});var d=c(60687);c(43210);var e=c(16189),f=c(4133),g=c(86446);function h({children:a,requiredRole:b}){let{user:c,loading:h,isAuthenticated:i}=(0,f.A)();return((0,e.useRouter)(),h)?(0,d.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,d.jsx)(g.k,{size:"lg"})}):i?b&&c?.role!==b?(0,d.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,d.jsxs)("div",{className:"text-center",children:[(0,d.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"访问被拒绝"}),(0,d.jsx)("p",{className:"text-gray-600",children:"您没有权限访问此页面。"})]})}):(0,d.jsx)(d.Fragment,{children:a}):null}},62209:(a,b,c)=>{c.d(b,{ProtectedRoute:()=>d});let d=(0,c(61369).registerClientReference)(function(){throw Error("Attempted to call ProtectedRoute() from the server but ProtectedRoute is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/kop/coding/KD_Family/components/auth/ProtectedRoute.tsx","ProtectedRoute")}};